image: php:7.4.0-fpm-buster
cache:
  paths:
    - vendor/


services:
  - redis:latest
  - postgres:lastest

stages:
  - build
  - test
variables:
  DB_HOST: mysql

  POSTGRES_USER: admin
  POSTGRES_PASSWORD: 123
  POSTGRES_DB: cv_ludwig
  DOCKER_DRIVER: overlay2
  # See https://github.com/docker-library/docker/pull/166
  DOCKER_TLS_CERTDIR: ""

before_script:
  - apt-get update && apt-get install -y gnupg2 curl wget
  - docker-php-ext-install -j$(nproc) xml && docker-php-ext-install -j$(nproc) ctype && docker-php-ext-install -j$(nproc) zip unzip && docker-php-ext-install -j$(nproc) geoip && docker-php-ext-install -j$(nproc) mbstring && docker-php-ext-install -j$(nproc) readline && docker-php-ext-install -j$(nproc) uuid && docker-php-ext-install -j$(nproc) simplexml && docker-php-ext-install -j$(nproc) json && docker-php-ext-install -j$(nproc) phar && docker-php-ext-install -j$(nproc) curl && docker-php-ext-install -j$(nproc) memcached && docker-php-ext-install -j$(nproc) intl && docker-php-ext-install -j$(nproc) odbc && docker-php-ext-install -j$(nproc) opcache && docker-php-ext-install -j$(nproc) yaml && docker-php-ext-install -j$(nproc) cli && docker-php-ext-install -j$(nproc) dom && docker-php-ext-install -j$(nproc) fpm && docker-php-ext-install -j$(nproc) apcu && docker-php-ext-install -j$(nproc) pdo && docker-php-ext-install -j$(nproc) dev && docker-php-ext-install -j$(nproc) xml && docker-php-ext-install -j$(nproc) intl && docker-php-ext-install -j$(nproc) gd && docker-php-ext-install -j$(nproc) redis -y
  - php -r "readfile('http://getcomposer.org/installer');" | php -- --install-dir=/usr/bin/ --filename=composer
  - cp tools/docker/web/php.ini /etc/php/7.4/fpm/php.ini

build:
  stage: build
  tags:
    - docker
  script:
    - ls -l
    - composer install --no-dev --ignore-platform-reqs --no-suggest --no-progress --no-scripts --prefer-dist
    - ls vendor/

test:
  stage: test
  script:
    - php bin/console doctrine:schema:update --force --env=test
    - php bin/console doctrine:fixture:load --no-interaction --env=test
    - php bin/phpunit
  dependencies:
    - build