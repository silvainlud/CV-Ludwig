image: php:7.4.0-fpm-buster:latest
cache:
  paths:
    - vendor/

stages:
  - build
  - test
variables:
  DB_HOST: mysql

  POSTGRES_USER: admin
  POSTGRES_PASSWORD: 123
  POSTGRES_DB: cv_ludwig
  DOCKER_DRIVER: overlay2
  # See https://github.com/docker-library/docker/pull/166
  DOCKER_TLS_CERTDIR: ""


build:
  stage: build
  tags:
    - docker
  script:
    - ls -l
    - docker-compose up -d redis database
#    - composer install --prefer-dist --no-ansi --no-interaction --no-progress
    - docker run --rm --name composerinstall -v "$PWD":/var/www/app -w /var/www/app composer:1.4 install --no-dev --ignore-platform-reqs --no-suggest --no-progress --no-scripts --prefer-dist
    - ls vendor/

test:
  stage: test
  script:
    - docker-compose.exe exec web php bin/console doctrine:schema:update --force --env=test
    - docker-compose.exe exec web php bin/console doctrine:fixture:load --no-interaction --env=test
    - docker-compose.exe exec web php bin/phpunit
  dependencies:
    - build